<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif;}
        #hidden-wrapper { position: absolute; top: -9999px; left: -9999px; }
        #pdf-container {
            width: 210mm; 
            min-height: 297mm; 
            background-color: #ffffff !important; 
            padding: 10mm 15mm; 
            box-sizing: border-box; 
            display: flex;
            flex-direction: column;
        }
        .print-format {
            font-weight: bold;
            line-height: 1.4; 
            color: black;
        }
        .text-red-print { color: #FF0000; }
    </style>
</head>
<body class="bg-gray-50 pb-10">
    <div class="max-w-md mx-auto mt-6 bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤ PDF (‡πÉ‡∏´‡∏ç‡πà‡∏û‡∏¥‡πÄ‡∏®‡∏©)</h2>
        
        <div id="main-content">
            <div class="mb-4 p-3 bg-gray-100 rounded-lg border border-gray-300">
                <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</p>
                <p class="font-bold text-lg">‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏π</p>
                <p class="font-bold text-lg">‡πÇ‡∏ó‡∏£ 096-889-6299</p>
            </div>

            <div id="input-section">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
                    <input type="text" id="receiverName" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
                    <textarea id="receiverAddress" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
                    <input type="tel" id="receiverPhone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <textarea id="items" rows="2" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"></textarea>
                </div>

                <button id="btn-add" onclick="saveRecipient()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-lg text-lg shadow-md mb-2">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>
                <button id="btn-cancel-edit" onclick="cancelEdit()" class="w-full bg-gray-400 text-white font-bold py-2 rounded-lg mb-6" style="display: none;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>

            <hr class="mb-6 border-gray-300">
            <div class="mb-6">
                <h3 class="font-bold text-gray-700 mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (<span id="list-count">0</span>)</h3>
                <ul id="recipientList" class="bg-gray-50 border border-gray-200 rounded-lg p-2 min-h-[60px] max-h-[200px] overflow-y-auto">
                    <li class="text-center text-gray-400 py-3 text-sm" id="empty-msg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                </ul>
            </div>
            <button id="btn-reset" onclick="resetForm()" class="w-full bg-red-400 text-white font-bold py-2 rounded-lg mb-6" style="display: none;">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <button id="btn-prepare" onclick="preparePDF()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg text-xl shadow-lg opacity-50 cursor-not-allowed" disabled>‚öôÔ∏è 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå PDF</button>
        <button id="btn-share" onclick="sharePDF()" class="w-full bg-green-500 text-white font-bold py-4 rounded-lg text-xl shadow-lg mb-2" style="display: none;">üì§ 2. ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤ LINE / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="btn-back-edit" onclick="goBackToEdit()" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-lg text-lg shadow-md" style="display: none;">üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="hidden-wrapper">
        <div id="pdf-container" class="print-format">
            <div id="sender-area" style="margin-bottom: 5mm;">
                ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏π<br>‡πÇ‡∏ó‡∏£ 096-889-6299
            </div>
            <div id="receiver-area" style="margin-bottom: 3mm;">
                ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö <span id="outName"></span><br>
                <span id="outAddress"></span><br>
                ‡πÇ‡∏ó‡∏£ <span id="outPhone"></span>
            </div>
            <div id="items-area" class="text-red-print">
                <span id="outItems"></span>
            </div>
        </div>
    </div>

    <script>
        let recipients = JSON.parse(localStorage.getItem('savedRecipients')) || [];
        let readyFile = null;
        let editingIndex = -1;

        window.onload = () => { updateListUI(); if(recipients.length > 0) document.getElementById('btn-reset').style.display = 'block'; };

        function saveRecipient() {
            const data = {
                name: document.getElementById('receiverName').value.trim() || '-',
                address: document.getElementById('receiverAddress').value.trim() || '-',
                phone: document.getElementById('receiverPhone').value.trim() || '-',
                items: document.getElementById('items').value.trim() || ''
            };
            if (editingIndex > -1) recipients[editingIndex] = data; else recipients.push(data);
            cancelEdit(); localStorage.setItem('savedRecipients', JSON.stringify(recipients)); goBackToEdit(); updateListUI();
            document.getElementById('btn-reset').style.display = 'block';
        }

        function editRecipient(index) {
            goBackToEdit(); const rec = recipients[index];
            document.getElementById('receiverName').value = rec.name;
            document.getElementById('receiverAddress').value = rec.address;
            document.getElementById('receiverPhone').value = rec.phone;
            document.getElementById('items').value = rec.items;
            editingIndex = index;
            document.getElementById('btn-add').innerText = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            document.getElementById('btn-cancel-edit').style.display = 'block';
            window.scrollTo(0,0);
        }

        function cancelEdit() {
            editingIndex = -1;
            document.getElementById('receiverName').value = '';
            document.getElementById('receiverAddress').value = '';
            document.getElementById('receiverPhone').value = '';
            document.getElementById('items').value = '';
            document.getElementById('btn-add').innerText = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            document.getElementById('btn-cancel-edit').style.display = 'none';
        }

        function removeRecipient(index) {
            if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) { recipients.splice(index,1); localStorage.setItem('savedRecipients', JSON.stringify(recipients)); goBackToEdit(); updateListUI(); }
        }

        function updateListUI() {
            const list = document.getElementById('recipientList');
            document.getElementById('list-count').innerText = recipients.length;
            list.innerHTML = recipients.length ? '' : '<li class="text-center text-gray-400 py-3 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>';
            recipients.forEach((rec, i) => {
                list.innerHTML += `<li class="flex justify-between items-center bg-white border rounded p-2 mb-2 text-sm">
                    <div class="truncate font-semibold">${i+1}. ${rec.name}</div>
                    <div><button onclick="editRecipient(${i})" class="text-blue-500 px-2 border-r">‡πÅ‡∏Å‡πâ</button>
                    <button onclick="removeRecipient(${i})" class="text-red-500 px-2">‡∏•‡∏ö</button></div></li>`;
            });
            document.getElementById('btn-prepare').disabled = !recipients.length;
            document.getElementById('btn-prepare').classList.toggle('opacity-50', !recipients.length);
        }

        async function preparePDF() {
            const btn = document.getElementById('btn-prepare');
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...'; btn.disabled = true;
            try {
                await document.fonts.ready;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();

                for (let i = 0; i < recipients.length; i++) {
                    const rec = recipients[i];
                    
                    // üìå ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î Font ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∞‡πÉ‡∏à
                    const totalChars = rec.name.length + rec.address.length + rec.items.length;
                    let fontSize = '40pt';
                    if (totalChars < 60) fontSize = '55pt'; 
                    else if (totalChars < 130) fontSize = '48pt';
                    else if (totalChars > 300) fontSize = '32pt';

                    const container = document.getElementById('pdf-container');
                    container.style.fontSize = fontSize;

                    document.getElementById('outName').innerText = rec.name;
                    document.getElementById('outAddress').innerHTML = rec.address.replace(/\n/g, '<br>');
                    document.getElementById('outPhone').innerText = rec.phone;
                    document.getElementById('outItems').innerHTML = rec.items.replace(/\n/g, '<br>');

                    await new Promise(r => setTimeout(r, 150));
                    const canvas = await html2canvas(container, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                    const imgData = canvas.toDataURL('image/jpeg', 0.85); // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
                    if (i > 0) pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, (canvas.height * pdfWidth) / canvas.width);
                }

                const d = new Date();
                const dateStr = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()+543}`;
                
                // üìå ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏£‡∏∞‡∏ö‡∏∏ Type ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ LINE ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå
                readyFile = new File([pdf.output('blob')], `‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤_${recipients.length}‡∏Ñ‡∏ô_${dateStr}.pdf`, { type: 'application/pdf' });
                
                document.getElementById('btn-prepare').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('btn-share').style.display = 'block';
                document.getElementById('btn-back-edit').style.display = 'block';
            } catch (e) { alert(e.message); btn.disabled = false; }
        }

        function goBackToEdit() {
            readyFile = null;
            document.getElementById('btn-prepare').innerHTML = '‚öôÔ∏è 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå PDF';
            document.getElementById('btn-prepare').style.display = 'block';
            document.getElementById('btn-share').style.display = 'none';
            document.getElementById('btn-back-edit').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            updateListUI();
        }

        async function sharePDF() {
            if (!readyFile) return;
            // üìå ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà Title ‡πÉ‡∏ô navigator.share ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ LINE ‡∏¢‡∏≠‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå
            if (navigator.canShare && navigator.canShare({ files: [readyFile] })) {
                await navigator.share({ 
                    files: [readyFile], 
                    title: '‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏ PDF' 
                });
            } else {
                const url = URL.createObjectURL(readyFile);
                const a = document.createElement('a');
                a.href = url;
                a.download = readyFile.name;
                a.click();
            }
        }

        function resetForm() { if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) { localStorage.removeItem('savedRecipients'); recipients = []; cancelEdit(); updateListUI(); document.getElementById('btn-reset').style.display = 'none'; } }
    </script>
</body>
</html>